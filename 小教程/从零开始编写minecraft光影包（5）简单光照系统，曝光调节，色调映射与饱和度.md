**å®Œæ•´èµ„æºï¼š**

 [æˆ‘çš„Githubåœ°å€](https://github.com/AKGWSB/Hello-Minecraft-Shaders/tree/master)

**å‰æƒ…æè¦ï¼š**

[ä»0å¼€å§‹ç¼–å†™minecraftå…‰å½±åŒ…ï¼ˆ0ï¼‰GLSLï¼Œåæ ‡ç³»ï¼Œå…‰å½±åŒ…ç»“æ„ä»‹ç»](https://blog.csdn.net/weixin_44176696/article/details/108152896)

[ä»é›¶å¼€å§‹ç¼–å†™minecraftå…‰å½±åŒ…ï¼ˆ1ï¼‰åŸºç¡€é˜´å½±ç»˜åˆ¶](https://blog.csdn.net/weixin_44176696/article/details/108625077)

[ä»é›¶å¼€å§‹ç¼–å†™minecraftå…‰å½±åŒ…ï¼ˆ2ï¼‰é˜´å½±ä¼˜åŒ–](https://blog.csdn.net/weixin_44176696/article/details/108637819)

[ä»é›¶å¼€å§‹ç¼–å†™minecraftå…‰å½±åŒ…ï¼ˆ3ï¼‰åŸºç¡€æ³›å…‰ç»˜åˆ¶](https://blog.csdn.net/weixin_44176696/article/details/108672719)

[ä»é›¶å¼€å§‹ç¼–å†™minecraftå…‰å½±åŒ…ï¼ˆ4ï¼‰æ³›å…‰æ€§èƒ½ä¸å“è´¨ä¼˜åŒ–](https://blog.csdn.net/weixin_44176696/article/details/108692525)


@[TOC](ç›®å½•)

# å‰è¨€
å›½åº†æ”¾å‡æ‘¸é±¼å¥½ä¹…äº†ã€‚ã€‚ã€‚ä»Šå¤©æ¥æ›´æ–°ä¸€ä¸‹ç½¢

ä¸Šæ¬¡è®²åˆ°å®ç°äº†æ›´å¥½å“è´¨çš„æ³›å…‰ï¼Œå¯æ˜¯å› ä¸ºmcçš„å…‰ç…§ç³»ç»Ÿè¿‡äºè›‹ç–¼ï¼Œè¿˜æ˜¯å­˜åœ¨ç§ç§é—®é¢˜ã€‚ä»Šå¤©æ¥è§£å†³å…¶ä»–çš„é—®é¢˜ã€‚

> æ³¨ï¼šè¿™éƒ¨åˆ†çš„å†…å®¹åŸºäº[ä¸Šä¸€ç¯‡åšå®¢](https://blog.csdn.net/weixin_44176696/article/details/108692525)ä¸­ã€å¯¹ä½åˆ†è¾¨ç‡çº¹ç†è¿›è¡Œæ¨¡ç³Šã€‘å°èŠ‚çš„ä»£ç 

# å…‰ç…§ç³»ç»Ÿ

å…‰ç…§æ˜¯ç€è‰²å™¨é¢ä¸´çš„é‡è¦éƒ¨åˆ†ã€‚ä¸€ä¸ªå¥½çš„å…‰ç…§ç³»ç»Ÿèƒ½å¤Ÿè®©ç€è‰²å™¨ç”»é¢æ›´åŠ é€¼çœŸã€‚åœ¨ä¸Šä¸€ç¯‡çš„ç€è‰²å™¨ä¸­ï¼Œæˆ‘ä»¬è™½ç„¶è§£å†³äº†æ³›å…‰çš„é—®é¢˜ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨å¾ˆå¤šæ½œåœ¨çš„é—®é¢˜ï¼š


é¦–å…ˆæ˜¯å…‰æºæ–¹å—ä¹Ÿä¼šè¢«æŸ“ä¸Šé˜´å½±

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003142425828.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

å› ä¸ºé˜´å½±çš„å…³ç³»ï¼Œæš—å¤„çš„æ–¹å—é¢œè‰²ä¼šéå¸¸æš—ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003142807677.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

è€Œå¤œé—´åˆ™ä¼šæ˜¾å¾—éå¸¸äº®ï¼Œå°¤å…¶æ˜¯äººé€ å…‰æºçš„äº®åº¦å’Œå¤ªé˜³çš„äº®åº¦ç›¸ç­‰ï¼Œè¿™æ˜¯æœ‰è¿å¸¸è¯†çš„ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003143413862.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

æ‰€ä»¥æˆ‘ä»¬è¿«åˆ‡éœ€è¦æ”¹å†™mcçš„å…‰ç…§ç³»ç»Ÿã€‚æˆ‘ä»¬å°†å…‰ç…§ç®€å•çš„åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

1. è‡ªç„¶ç¯å¢ƒå…‰ï¼Œç”±å¤ªé˜³å’Œæœˆäº®æä¾›
2. äººé€ å…‰æºç…§æ˜ï¼Œç”±ç©å®¶æ”¾ç½®çš„æ–¹å—æä¾›

å‘å…‰ç‰©ä½“ç¡®å®šåï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®å…‰ç…§çš„å‡ æ¡è§„åˆ™ï¼š

1. è‡ªç„¶ç¯å¢ƒå…‰çš„å¼ºåº¦è¿œå¤§äºäººé€ å…‰æºçš„ç…§æ˜å¼ºåº¦
2. å¤œé—´çš„æ—¶å€™ï¼Œè‡ªç„¶ç¯å¢ƒå…‰çš„å¼ºåº¦åº”è¯¥å‡å°‘ã€‚
3. å½“è‡ªç„¶å…‰å’Œäººé€ å…‰æºéƒ½å­˜åœ¨æ—¶ï¼Œå–æœ€å¤§çš„ä¸€æ–¹ä½œä¸ºæœ€ç»ˆå…‰ç…§çš„ç»“æœ

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ gbuffers_terrain ç€è‰²å™¨ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è®¡ç®—å…‰ç…§ã€‚

è¿˜è®°å¾—é¡¶ç‚¹ç€è‰²å™¨ä¸­çš„å…‰ç…§çº¹ç†åæ ‡ğŸï¼Ÿ

```
lightMapCoord = gl_TextureMatrix[1] * gl_MultiTexCoord1;   
```

å…¶ä¸­ lightMapCoord  çš„ x è½´è¡¨ç¤ºäººé€ å…‰æºçš„å¼ºåº¦ï¼Œy è½´è¡¨ç¤ºè‡ªç„¶å…‰æºçš„å¼ºåº¦ã€‚å¦‚æœæˆ‘ä»¬åœ¨ gbuffers_terrain ç€è‰²å™¨ç›´æ¥è¾“å‡ºä»–ä»¬çš„ x æˆ– y åæ ‡ï¼Œé‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹çš„ç»“æœï¼š

```
blockColor.rgb = vec3(lightMapCoord.x);

or 
 
blockColor.rgb = vec3(lightMapCoord.y);
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003150702970.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)
æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ gbuffers_terrain.fsh çš„å†…å®¹ï¼Œå®ç°æ˜¼å¤œå…‰ç…§çš„å˜åŒ–ï¼Œä»¥åŠäººé€ å…‰æºå’Œè‡ªç„¶å…‰æºçš„æ··åˆã€‚å°† gbuffers_terrain.fsh ä¿®æ”¹ä¸ºï¼š

```
#version 120

// å£°æ˜2å·é¢œè‰²ç¼“å†²åŒºä¸º R32F æ ¼å¼ åªæœ‰xé€šé“å¯ç”¨ ä¼ é€’æ–¹å—id
const int R32F = 114;
const int colortex2Format = R32F;

uniform sampler2D texture;
uniform sampler2D lightmap;

uniform int worldTime;

varying vec4 texcoord;
varying vec4 lightMapCoord;
varying vec3 color;
varying float blockId;

/* DRAWBUFFERS:023 */
void main() {

    // æ˜¼å¤œäº¤æ›¿æ’å€¼
    float isNight = 0;  // ç™½å¤©
    if(12000<worldTime && worldTime<13000) {
        isNight = 1.0 - (13000-worldTime) / 1000.0; // å‚æ™š
    }
    else if(13000<=worldTime && worldTime<=23000) {
        isNight = 1;    // æ™šä¸Š
    }
    else if(23000<worldTime) {
        isNight = (24000-worldTime) / 1000.0;   // æ‹‚æ™“
    }

    // çº¹ç† * é¢œè‰²
    vec4 blockColor = texture2D(texture, texcoord.st);
    blockColor.rgb *= color;

    // äººé€ å…‰æºå…‰ç…§
    float lightTorch = lightMapCoord.x * 0.4;
    // å¦‚æœæ˜¯å‘å…‰ç‰©ä½“åˆ™ä¸å—å…‰ç…§å½±å“
    if(blockId>=10089) {
        lightTorch /= 0.4;
    }
    // ç¯å¢ƒå…‰ç…§
    float lightSky = lightMapCoord.y;
    lightSky = pow(lightSky, 2);
    lightSky *= (1-isNight*0.8);   // å¤œæ™šåˆ™å‡å¼±
    // å…‰ç…§æ··åˆ--å–æœ€å¤§å€¼
    blockColor.rgb *= max(lightTorch, lightSky);

    gl_FragData[0] = blockColor;
    gl_FragData[1] = vec4(blockId);
    gl_FragData[2] = vec4(isNight, 0, 0, 0);
}
```

æˆ‘ä»¬åšäº†å¦‚ä¸‹çš„æ”¹åŠ¨ï¼š

1. è®¡ç®—æ˜¼å¤œäº¤æ›¿çš„å¹³æ»‘è¿‡æ¸¡å€¼ isNightã€‚å¦‚æœæ˜¯å¤œæ™šï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¸º1ï¼Œå¦åˆ™ä¸º0ã€‚åœ¨æ˜¼å¤œäº¤æ›¿çš„æ—¶å€™ï¼ŒisNightä¼šæ ¹æ®å½“å‰ä¸–ç•Œçš„ä¸–ç•Œ worldTime è¿›è¡Œå¹³æ»‘è¿‡æ¸¡
2. ç„¶åæˆ‘ä»¬è·å–äººé€ å…‰æºçš„å¼ºåº¦ï¼Œå³ lightMapCoord.x ï¼Œéšåæˆ‘ä»¬å‡å¼±äººé€ å…‰æºçš„å…‰ç…§å¼ºåº¦å³ä¹˜ä»¥0.4.ä½†æ˜¯å¦‚æœæ˜¯å‘å…‰æ–¹å—ï¼Œæˆ‘ä»¬ç…§å¸¸ç»˜åˆ¶å®ƒçš„é¢œè‰²
3. ç„¶åæˆ‘ä»¬å–å¾—ç¯å¢ƒå…‰ç…§çš„å¼ºåº¦ lightMapCoord.yï¼Œæ ¹æ®æ˜¼å¤œäº¤æ›¿å€¼ isNight å¯¹å…¶è¿›è¡Œå˜æ¢ã€‚ç™½æ˜¼åˆ™ä¸ºæ­£å¸¸å€¼ï¼Œå¤œé—´åˆ™å‡å¼±åˆ°åŸæ¥çš„0.2å€
4. å°†ä¸¤ç§å…‰æºçš„å¼ºåº¦è¿›è¡Œæ¯”è¾ƒï¼Œå–æœ€å¤§çš„ä¸€æ–¹ä½œä¸ºæœ€ç»ˆç…§æ˜çš„å¼ºåº¦
5. å°† isNight ç»§ç»­å†™å…¥ 3 å·é¢œè‰²ç¼“å†²åŒºï¼Œæ¥ä¸‹æ¥ç»˜åˆ¶æ˜¼å¤œé˜´å½±çš„æ—¶å€™ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªå€¼ï¼Œæ‰€ä»¥ä¿å­˜ä¸€ä¸‹

éšåæˆ‘ä»¬å°æ”¹ä¸€ä¸‹ composite.fshï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹é˜´å½±ç»˜åˆ¶è¿›è¡Œå¤„ç†ã€‚

æˆ‘ä»¬å°†å¤œé—´çš„é˜´å½±æ·¡åŒ–ï¼Œå³åœ¨getShadowå‡½æ•°ä¸­ï¼Œé€šè¿‡isNightæ¥å†³å®šé˜´å½±çš„æ·±åº¦ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003152949589.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)


æ­¤å¤–ï¼Œå¦‚æœä¸ºå…‰æºæ–¹å—ï¼Œåˆ™ä¸å¯¹å…¶ç»˜åˆ¶é˜´å½±ã€‚æˆ‘ä»¬å¯¹mainå‡½æ•°ä¸­çš„é˜´å½±ç»˜åˆ¶ä»£ç è¿›è¡Œä¿®æ”¹ï¼š

```
// ä¸æ˜¯å‘å…‰æ–¹å—åˆ™ç»˜åˆ¶é˜´å½±
float id = texture2D(colortex2, texcoord.st).x;
if(id!=10089 && id!=10090) {
    color = getShadow(color, positionInWorldCoord);
}
```



æ­¤å¤–ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œæ ¹æ®æ–¹å—idæ¥å†³å®šæ˜¯å¦ä¸ºå…‰æºæ–¹å—ï¼Œå¹¶ä¸”ä¼ é€’æ³›å…‰çš„åŸå§‹å›¾åƒã€‚

```
/*
 *  @function getBloomSource : è·å–æ³›å…‰åŸå§‹å›¾åƒ
 *  @param color             : åŸå›¾åƒ
 *  @return                  : æå–åçš„æ³›å…‰å›¾åƒ
 */
vec4 getBloomSource(vec4 color) {
    // ç»˜åˆ¶æ³›å…‰
    vec4 bloom = color;
    float id = texture2D(colortex2, texcoord.st).x;
    float brightness = dot(bloom.rgb, vec3(0.2125, 0.7154, 0.0721));
    // å‘å…‰æ–¹å—
    if(id==10089) {
        bloom.rgb *= 7 * vec3(2, 1, 1);
    }
    // ç«æŠŠ 
    else if(id==10090) {
        if(brightness<0.5) {
            bloom.rgb = vec3(0);
        }
        bloom.rgb *= 14 * pow(brightness, 2);
    }
    // å…¶ä»–æ–¹å—
    else {
        bloom.rgb *= brightness;
        bloom.rgb = pow(bloom.rgb, vec3(1.0/2.2));
    }
    return bloom;
}
```

ç„¶åä¿®æ”¹ composite.fsh çš„mainå‡½æ•°ï¼Œå°†æ³›å…‰çš„åŸå§‹å›¾åƒä¼ é€’åˆ° 1 å·é¢œè‰²ç¼“å†²åŒºï¼š

```
gl_FragData[1] = getBloomSource(color); // ä¼ é€’æ³›å…‰åŸå›¾
```

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ›´ä¸ºé€¼çœŸçš„å…‰ç…§æ•ˆæœï¼Œå³äººé€ å…‰æºï¼Œæ˜¼å¤œå…‰ç…§ï¼Œé˜´å½±çš„åè°ƒã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003153154432.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

# æ›å…‰è°ƒèŠ‚

å…‰ç…§çš„é—®é¢˜è§£å†³äº†ï¼Œå¯æ˜¯åˆæœ‰äº†æ–°çš„é—®é¢˜ï¼Œå› ä¸ºé˜´å½±çš„å…³ç³»ï¼ŒåŠ ä¸Šæˆ‘ä»¬ä¸ºäº†åœ¨éœ²å¤©åœºæ™¯ä¸‹ä½¿å¾—å…‰ç…§æ›´ä¸ºçœŸå®è€Œå‰Šå‡äº†äººé€ å…‰æºçš„å¼ºåº¦ï¼Œåœ¨å°é—­çš„å®¤å†…åœºæ™¯ï¼Œé¢œè‰²éå¸¸æš—ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003153722652.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

åœ¨ç°å®åœºæ™¯ä¸­ï¼Œåœ¨é˜´æš—çš„å®¤å†…ï¼Œæ‘„åƒæœºä¼šå¢å¤§å…‰åœˆï¼Œä½¿å¾—æ•´ä½“çš„äº®åº¦æé«˜ï¼Œè€Œåœ¨å®¤å¤–æ˜äº®åœºæ™¯ï¼Œåˆ™ä¼šç¼©å°å…‰åœˆï¼Œè®©ç”»é¢èƒ½å¤Ÿé€‚åº”å¼ºå…‰ã€‚æˆ‘ä»¬å¸Œæœ›å®ç°è¿™ä¸ªç‰¹æ•ˆã€‚

æŸ¥é˜…[Optifineçš„æ–‡æ¡£](https://github.com/sp614x/optifine/blob/master/OptiFineDoc/doc/shaders.txt)å‘ç°æœ‰ eyeBrightness å’Œ eyeBrightnessSmooth ä¸¤ä¸ªå˜é‡ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003154153260.png#pic_center)

è¯¥å˜é‡ä»£è¡¨äº†**ç©å®¶æ‰€åœ¨ä½ç½®**çš„å…‰ç…§äº®åº¦ï¼Œå…¶ä¸­ x è½´æ˜¯äººé€ å…‰æºçš„å¼ºåº¦ï¼Œy è½´æ˜¯è‡ªç„¶å…‰æºçš„å¼ºåº¦ã€‚å…‰ç…§çš„å€¼èŒƒå›´ [0~240] å¯¹åº” 16 ä¸ªå…‰ç…§å¼ºåº¦ã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡ y è½´ï¼ˆå³è‡ªç„¶å…‰æºçš„å¼ºåº¦ï¼‰æ¥åˆ¤æ–­å½“å‰å¤„äºå®¤å†…è¿˜æ˜¯å®¤å¤–ã€‚å¦‚æœæ˜¯å®¤å†…æˆ‘ä»¬åˆ™å¢äº®ï¼ˆä¹˜ä»¥ä¸€ä¸ªå¤§äº1çš„æ•°å­—ï¼‰ï¼Œå®¤å¤–åˆ™æ¢å¤åˆ°åŸæ¥çš„æ°´å¹³ï¼ˆ1.0ï¼‰ã€‚

æˆ‘ä»¬åœ¨ final.fsh ä¸­åŠ å…¥å¦‚ä¸‹çš„å‡½æ•°ï¼š

```
/*
 *  @function exposure : æ›å…‰è°ƒèŠ‚
 *  @param color       : åŸé¢œè‰²
 *  @param factor      : è°ƒæ•´å› å­ èŒƒå›´ 0~1
 *  @explain           : factorè¶Šå¤§åˆ™æš—å¤„è¶Šäº®
 */ 
vec3 exposure(vec3 color, float factor) {
    float skylight = float(eyeBrightnessSmooth.y)/240;
    skylight = pow(skylight, 6.0) * factor + (1.0f-factor);
    return color / skylight;
}
```

ç„¶ååœ¨ final.fsh çš„mainå‡½æ•°ä¸­åŠ å…¥ï¼š

```
// æ›å…‰è°ƒèŠ‚
color.rgb = exposure(color.rgb, 0.7);
```

é‡æ–°åŠ è½½å…‰å½±åŒ…ï¼Œæˆ‘ä»¬å‘ç°ç°åœ¨å®¤å†…åŸºæœ¬èƒ½å¤Ÿçœ‹æ¸…äº†ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003154858651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

å¹¶ä¸”ä»æ˜æš—çš„å®¤å†…èµ°å‘å®¤å¤–ï¼Œå¯ä»¥ä½“éªŒåˆ°éå¸¸ç¾å¤§ä¸Šçš„æ›å…‰è°ƒèŠ‚è¿‡ç¨‹ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003155405828.gif#pic_center)

# ToneMapping

è§£å†³äº†æ›å…‰è°ƒèŠ‚ä¹‹åï¼Œåˆæœ‰äº†æ–°çš„é—®é¢˜ã€‚å› ä¸ºæ›å…‰è°ƒèŠ‚åœ¨å®¤å†…ï¼ˆæˆ–è€…ç¯å¢ƒå…‰å¼ºåº¦ä¸å¤Ÿçš„åœ°æ–¹ï¼‰ä¼šæé«˜äº®ï¼Œæ•…åº¦å®¤å†…äº®åº¦è¿‡äº®ï¼Œå…‰æºæ–¹å—ç›´æ¥è¶…äº®äº†ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003160414279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

è¿‡äº®çš„å›¾ç‰‡é€ æˆçš„åæœæ˜¯ç»†èŠ‚çš„ç¼ºå¤±ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ç®—æ³•ï¼Œèƒ½å¤Ÿå°†äº®çš„å›¾åƒå’Œæš—çš„å›¾åƒç»¼åˆä¸€ä¸‹ï¼Œè¿˜åŸäº®å¤„çš„ç»†èŠ‚ï¼Œè¿™ç§ç®—æ³•å«åšToneMappingã€‚

Tonemappingåˆåè‰²è°ƒæ˜ å°„ã€‚æ„åœ¨é€šè¿‡ä¸€å®šçš„æ˜ å°„æ–¹å¼ï¼Œå°†äº®å’Œæš—çš„åƒç´ ä¸­å’Œï¼Œä»é«˜äº®å›¾ç‰‡ä¸­è¿˜åŸå›¾åƒçš„ç»†èŠ‚ã€‚ToneMappingé€šè¿‡ä¸€ç§å‡½æ•°ï¼Œå°†åƒç´ çš„äº®åº¦ç”±çº¿æ€§å˜ä¸ºéçº¿æ€§ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003161224826.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)
è¿™ä¹ˆåšçš„ç›®çš„å°±æ˜¯**å°†é«˜äº®åƒç´ å’Œä½äº®åº¦åƒç´ ï¼Œå‘ä¸­ç­‰äº®åº¦çš„åŒºåŸŸå‹ç¼©**ï¼Œä»¥è¿˜åŸæ›´å¤šçš„ç»†èŠ‚ã€‚

ToneMappingç®—æ³•çš„ä¸åŒï¼Œåœ¨äºå…¶æ›²çº¿çš„ä¸åŒï¼Œä¸€èˆ¬æ›²çº¿é€šè¿‡å¤šé¡¹å¼æ‹Ÿåˆå³å¯ã€‚æ•…ç›´æ¥é€‰å–æ¯”è¾ƒç°æˆçš„ToneMappingç®—æ³•ï¼Œæ¥è‡ªè¿™ç¯‡æ–‡ç« ï¼š

[Tone mappingè¿›åŒ–è®º](https://zhuanlan.zhihu.com/p/21983679)

æˆ‘ä»¬ç›´æ¥copy ACES ToneMapping çš„ç®—æ³•ï¼š

```
/*
 *  @function ACESToneMapping : è‰²è°ƒæ˜ å°„
 *  @param color              : åŸé¢œè‰²
 *  @param adapted_lum        : äº®åº¦è°ƒæ•´å› å­
 *  @return                   : è‰²è°ƒæ˜ å°„ä¹‹åçš„å€¼
 *  @explain                  : æ„Ÿè°¢çŸ¥ä¹å¤§ä½¬ï¼š@å›é€†è€…
 *                            : æºç åœ°å€ https://zhuanlan.zhihu.com/p/21983679
 */
vec3 ACESToneMapping(vec3 color, float adapted_lum) {
	const float A = 2.51f;
	const float B = 0.03f;
	const float C = 2.43f;
	const float D = 0.59f;
	const float E = 0.14f;
	color *= adapted_lum;
	return (color * (A * color + B)) / (color * (C * color + D) + E);
}
```

ç„¶åæˆ‘ä»¬ä¿®æ”¹ final.fsh ï¼Œåœ¨è®¡ç®—æ›å…‰è°ƒèŠ‚ä¹‹åï¼ŒåŠ ä¸Šä¸€è¡Œï¼š

```
// è‰²è°ƒæ˜ å°„
color.rgb = ACESToneMapping(color.rgb, 1);
```

é‡æ–°åŠ è½½å…‰å½±åŒ…ï¼Œç°åœ¨å¯ä»¥çœ‹çœ‹æ•ˆæœåŠ›ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003162151544.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)
å¯ä»¥çœ‹åˆ°æ•ˆæœè¿˜æ˜¯éå¸¸ç»™åŠ›çš„ã€‚ã€‚ã€‚æ„Ÿè°¢çŸ¥ä¹å¤§ä½¬çš„è®²è§£ Orz

# é¥±å’Œåº¦ä¸æ»¤é•œ

åœ¨è¿›è¡Œè‰²è°ƒæ˜ å°„åï¼Œè¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼šå›¾åƒçš„é¢œè‰²ä¸å¤Ÿé²œè‰³äº†ï¼Œè¿™æ˜¯å› ä¸ºToneMappingæŠŠæ‰€æœ‰æœ¬ä¸é²œè‰³çš„é¢œè‰²ï¼Œå‹ç¼©åˆ°ä¸­é—´åŒºé—´ï¼Œå¯¼è‡´é¢œè‰²ç°å¤´åœŸè„¸çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªæ»¤é•œï¼Œæ‰‹åŠ¨è°ƒèŠ‚å›¾åƒçš„é¥±å’Œåº¦ã€‚

> ä»€ä¹ˆæ˜¯é¥±å’Œåº¦å‘¢ï¼Ÿé¥±å’Œåº¦æè¿°äº†å›¾åƒé¢œè‰²çš„ä¸°å¯Œç¨‹åº¦ï¼Œå³ RGB å€¼è¶Š â€œç¦»æ•£â€ ï¼Œå›¾åƒé¥±å’Œåº¦è¶Šé«˜ã€‚
> å‚è€ƒè‡ª - - - [å…¬å¼å‰–æè‰²å½©ä¸‰è¦ç´ ï¼šè‰²ç›¸ã€é¥±å’Œåº¦ã€æ˜åº¦](https://zhuanlan.zhihu.com/p/30409532)


å…³äºRGBé¢œè‰²ç©ºé—´ä¸‹é¥±å’Œåº¦çš„è°ƒèŠ‚ï¼Œ~~ç›´æ¥æŠ„å…¬å¼å³å¯~~ ï¼Œ

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003172301526.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)
> 
> å‚è€ƒè‡ªï¼š[äº®åº¦ï¼Œé¥±å’Œåº¦ï¼Œå¯¹æ¯”åº¦çš„è®¡ç®—æ–¹æ³•](https://blog.csdn.net/gaowebber/article/details/79829962)

å…·ä½“æ­¥éª¤ï¼š

1. è®¡ç®—åƒç´ äº®åº¦
2. å°†åƒç´ äº®åº¦ä½œä¸ºç°åº¦å€¼ï¼Œå’ŒåŸåƒç´ å€¼è¿›è¡Œçº¿æ€§æ··åˆ

å…¶ä¸­ä¼ªä»£ç ä¸ºï¼š

```
newRGB = oldRGB * alpha + brightness * (1 - alpha)
```

å…¶ä¸­ alpha ä¸ºé¥±å’Œåº¦ç³»æ•°ï¼Œ0è¡¨ç¤ºå®Œå…¨ç°è‰²ï¼Œ0-1è¡¨ç¤ºé™ä½é¥±å’Œåº¦ï¼Œ1è¡¨ç¤ºåŸå›¾ï¼Œ**è¶…è¿‡1è¡¨ç¤ºå¢åŠ é¥±å’Œåº¦ã€‚**

æ‰€ä»¥æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒæ•´é¢œè‰²çš„é¥±å’Œåº¦ï¼š

```
/*
 *  @function saturation : é¥±å’Œåº¦è°ƒæ•´
 *  @param color         : åŸé¢œè‰²
 *  @param factor        : è°ƒæ•´å› å­èŒƒå›´ [0~æ— ç©·] é¥±å’Œåº¦å‡é«˜
 */ 
vec3 saturation(vec3 color, float factor) {
    float brightness = dot(color, vec3(0.2125, 0.7154, 0.0721));
    return mix(vec3(brightness), color, factor);
}
```

åœ¨ final.fsh ä¸­ï¼Œè®¡ç®—tonemappingä¹‹åï¼ŒåŠ å…¥ï¼š

```
// é¥±å’Œåº¦
color.rgb = saturation(color.rgb, 1.5);
```

ä½¿ç”¨ä¸åŒçš„é¥±å’Œåº¦ç³»æ•°ï¼ˆå³å…¬å¼ä¸­çš„ alphaï¼‰ï¼Œå¯ä»¥è°ƒèŠ‚ä¸åŒçš„æ•ˆæœï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003172855495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

æœ€ç»ˆä½¿ç”¨ 1.5 ä½œä¸ºç³»æ•°ï¼Œå³å¯è¾¾åˆ°ä¸é”™çš„æ•ˆæœï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003173245317.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003173542732.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003173659555.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201003174644995.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE3NjY5Ng==,size_16,color_FFFFFF,t_70#pic_center)


